#!/bin/bash

if ! cd "$(git rev-parse --show-toplevel)"; then
  echo "cd error"
  exit 1
fi

branch=$(git rev-parse --abbrev-ref HEAD)
# shellcheck disable=SC2063
ancestor_branch=$(git show-branch | grep '*' | grep -v "${branch}" | head -1 | awk -F'[]~^[]' '{print $2}')

if git rev-parse --verify origin/"${branch}" >/dev/null 2>&1; then
  from=$(git merge-base HEAD origin/"${branch}")
else
  # æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆ
  from=${ancestor_branch}
fi

# Luaãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿StyLuaãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
if git diff --name-only "${from}".."${branch}" | grep -Eq "\.lua$"; then
  echo "ğŸ¨ Running StyLua format check"
  if ! stylua --check .; then
    echo "âŒ StyLua format check failed. Please run 'stylua .' to format your code."
    exit 1
  fi
  echo "âœ… StyLua format check passed"
fi

exit 0